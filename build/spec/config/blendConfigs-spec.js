// Generated by CoffeeScript 1.6.3
var arrayizeUniquePusher, assert, blendConfigs, bundleBuildBlender, chai, dependenciesBindingsBlender, expect, expectedResources, moveKeysBlender, renameKeysBlender, resources, resourcesBlender, templateBlender, uRequireConfigMasterDefaults, _;

chai = require('chai');

assert = chai.assert;

expect = chai.expect;

_ = require('lodash');

blendConfigs = require('../../code/config/blendConfigs');

uRequireConfigMasterDefaults = require('../../code/config/uRequireConfigMasterDefaults');

moveKeysBlender = blendConfigs.moveKeysBlender, renameKeysBlender = blendConfigs.renameKeysBlender, resourcesBlender = blendConfigs.resourcesBlender, templateBlender = blendConfigs.templateBlender, arrayizeUniquePusher = blendConfigs.arrayizeUniquePusher, dependenciesBindingsBlender = blendConfigs.dependenciesBindingsBlender, bundleBuildBlender = blendConfigs.bundleBuildBlender;

resources = [
  [
    'Coffeescript', ['**/*.coffee', /.*\.(coffee\.md|litcoffee)$/i, '!**/*.amd.coffee'], function(source) {
      return source;
    }, function(filename) {
      return filename.replace('.coffee', '.js');
    }
  ], [
    'Streamline', '**/*._*', function(source) {
      return source;
    }, function(filename) {
      return filename.replace('._js', '.js');
    }
  ], {
    name: '#NonModule',
    filez: '**/*.nonmodule',
    convert: function() {}
  }, [
    '#*NonModule-NonTerminal resource', '**/*.ext', function(source) {
      return source;
    }
  ], {
    name: '#IamAModule',
    isModule: true,
    filez: '**/*.module',
    convert: function() {}
  }
];

expectedResources = [
  {
    name: 'Coffeescript',
    isModule: true,
    isTerminal: true,
    filez: ['**/*.coffee', /.*\.(coffee\.md|litcoffee)$/i, '!**/*.amd.coffee'],
    convert: resources[0][2],
    dstFilename: resources[0][3]
  }, {
    name: 'Streamline',
    isModule: true,
    isTerminal: true,
    filez: '**/*._*',
    convert: resources[1][2],
    dstFilename: resources[1][3]
  }, {
    name: 'NonModule',
    isModule: false,
    isTerminal: true,
    filez: '**/*.nonmodule',
    convert: resources[2].convert
  }, {
    name: 'NonModule-NonTerminal resource',
    isModule: false,
    isTerminal: false,
    filez: '**/*.ext',
    convert: resources[3][2],
    dstFilename: resources[3][3]
  }, {
    name: 'IamAModule',
    isModule: true,
    isTerminal: true,
    filez: '**/*.module',
    convert: resources[4].convert
  }
];

describe('`uRequireConfigMasterDefaults` consistency', function() {
  return it("No same name keys in bundle & build ", function() {
    return expect(_B.isDisjoint(_.keys(uRequireConfigMasterDefaults.bundle), _.keys(uRequireConfigMasterDefaults.build))).to.be["true"];
  });
});

describe('blendConfigs & its Blenders', function() {
  describe('moveKeysBlender', function() {
    it("Copies keys from the 'root' of src, to either `dst.bundle` or `dst.build`, depending on where they are on `uRequireConfigMasterDefaults`", function() {
      return expect(moveKeysBlender.blend({
        name: 'myBundle',
        main: 'myMainLib',
        bundle: {
          main: 'myLib'
        },
        path: "/some/path",
        webRootMap: ".",
        dependencies: {
          depsVars: {},
          exports: {
            bundle: {}
          }
        },
        dstPath: "",
        forceOverwriteSources: false,
        template: {
          name: "UMD"
        },
        watch: false,
        noRootExports: false,
        scanAllow: false,
        allNodeRequires: false,
        verbose: false,
        debugLevel: 0
      })).to.deep.equal({
        bundle: {
          name: 'myBundle',
          main: 'myLib',
          path: "/some/path",
          webRootMap: ".",
          dependencies: {
            depsVars: {},
            exports: {
              bundle: {}
            }
          }
        },
        build: {
          dstPath: "",
          forceOverwriteSources: false,
          template: {
            name: "UMD"
          },
          watch: false,
          noRootExports: false,
          scanAllow: false,
          allNodeRequires: false,
          verbose: false,
          debugLevel: 0
        }
      });
    });
    it("it gives precedence to items in 'bundle' and 'build' hashes, over root items.", function() {
      return expect(moveKeysBlender.blend({
        main: 'myMainLib',
        bundle: {
          main: 'myLib'
        },
        dstPath: "/some/OTHER/path",
        build: {
          dstPath: "/some/path"
        }
      })).to.deep.equal({
        bundle: {
          main: 'myLib'
        },
        build: {
          dstPath: "/some/path"
        }
      });
    });
    return it("ignores root keys deemed irrelevant (not exist on `uRequireConfigMasterDefaults`'s `.build` or `.bundle`.)", function() {
      return expect(moveKeysBlender.blend({
        iRReLeVaNt_key_is_Ignored: true,
        name: 'myBundle',
        bundle: {
          bundle_iRReLeVaNt_key_is_NOT_Ignored: true,
          path: "/some/path"
        }
      })).to.deep.equal({
        bundle: {
          bundle_iRReLeVaNt_key_is_NOT_Ignored: true,
          name: 'myBundle',
          path: "/some/path"
        }
      });
    });
  });
  describe("renameKeysBlender:", function() {
    return it("renames DEPRACATED keys to their new name", function() {
      var oldCfg;
      oldCfg = {
        bundle: {
          bundlePath: "source/code",
          main: "index",
          filespecs: '*.*',
          ignore: [/^draft/],
          dependencies: {
            bundleExports: {
              lodash: '_'
            },
            _knownVariableNames: {
              jquery: '$'
            }
          }
        }
      };
      return expect(renameKeysBlender.blend(oldCfg)).to.be.deep.equal({
        bundle: {
          path: 'source/code',
          main: 'index',
          filez: '*.*',
          ignore: [/^draft/],
          dependencies: {
            exports: {
              bundle: {
                lodash: '_'
              }
            },
            _knownDepsVars: {
              jquery: '$'
            }
          }
        }
      });
    });
  });
  describe("templateBlender:", function() {
    describe("template is a String:", function() {
      it("converts to {name:'TheString'} ", function() {
        return expect(templateBlender.blend('UMD')).to.deep.equal({
          name: 'UMD'
        });
      });
      it("converts & blends to {name:'TheString'} ", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, 'UMD')).to.deep.equal({
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        });
      });
      return it("resets dest Object if src name is changed", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, 'combined')).to.deep.equal({
          name: 'combined'
        });
      });
    });
    return describe("template is {}:", function() {
      it("blends to existing ", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, {
          name: 'UMD'
        })).to.deep.equal({
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        });
      });
      return it("resets dest Object if template.name is changed", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, {
          name: 'combined'
        })).to.deep.equal({
          name: 'combined'
        });
      });
    });
  });
  describe("resourcesBlender:", function() {
    return it("converts array of array resources into array of object resources", function() {
      return expect(resourcesBlender.blend(resources)).to.deep.equal(expectedResources);
    });
  });
  describe("arrayizeUniquePusher:", function() {
    it("pushes source array items into destination array", function() {
      return expect(arrayizeUniquePusher.blend([1, 2, 3], [4, 5, 6, '7'])).to.deep.equal([1, 2, 3, 4, 5, 6, '7']);
    });
    it("pushes only === unique items", function() {
      return expect(arrayizeUniquePusher.blend([1, 4, 2, 3], [1, 2, 4, 5, 6, '7'])).to.deep.equal([1, 4, 2, 3, 5, 6, '7']);
    });
    it("pushes source array items into non-array destination, arrayize'ing it first", function() {
      return expect(arrayizeUniquePusher.blend(123, [4, 5, 6])).to.deep.equal([123, 4, 5, 6]);
    });
    it("pushes source non-array (but a String) item into array destination", function() {
      return expect(arrayizeUniquePusher.blend(['1', '2', '3'], '456')).to.deep.equal(['1', '2', '3', '456']);
    });
    it("pushes non-array (but Strings) items onto each other", function() {
      return expect(arrayizeUniquePusher.blend('123', '456')).to.deep.equal(['123', '456']);
    });
    return it("resets destination array & then pushes - using signpost `[null]` as 1st src item", function() {
      return expect(arrayizeUniquePusher.blend(['items', 'to', 'remove'], [[null], 11, 22, 33])).to.deep.equal([11, 22, 33]);
    });
  });
  describe("`dependenciesBindingsBlender` converts to proper dependenciesBinding structure\n{dependency1:ArrayOfDep1Bindings, dependency2:ArrayOfDep2Bindings, ...}\ni.e `{lodash:['_'], jquery: ['$']}` :", function() {
    it("converts String: `'lodash'`  --->   `{lodash:[]}`", function() {
      return expect(dependenciesBindingsBlender.blend('lodash')).to.deep.equal({
        lodash: []
      });
    });
    it("converts Array<String>: `['lodash', 'jquery']` ---> `{lodash:[], jquery:[]}`", function() {
      return expect(dependenciesBindingsBlender.blend(['lodash', 'jquery'])).to.deep.equal({
        lodash: [],
        jquery: []
      });
    });
    it("converts Object {lodash:['_'], jquery: '$'}` ---> {lodash:['_'], jquery: ['$']}`", function() {
      return expect(dependenciesBindingsBlender.blend({
        lodash: ['_'],
        jquery: '$'
      })).to.deep.equal({
        lodash: ['_'],
        jquery: ['$']
      });
    });
    return it("converts from all in chain ", function() {
      return expect(dependenciesBindingsBlender.blend({}, 'myLib', {
        lodash: ['_'],
        jquery: '$'
      }, ['uberscore', 'uderive'], {
        jquery: 'jQuery'
      }, 'urequire', {
        'uberscore': ['rules']
      })).to.deep.equal({
        myLib: [],
        lodash: ['_'],
        jquery: ['$', 'jQuery'],
        uberscore: ['rules'],
        uderive: [],
        urequire: []
      });
    });
  });
  return describe("`blendConfigs`:", function() {
    describe("`bundle: dependencies`:", function() {
      it("exports.bundle String depBindings is turned to {dep:[]}", function() {
        return expect(blendConfigs([
          {
            dependencies: {
              exports: {
                bundle: 'lodash'
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': []
                }
              }
            }
          }
        });
      });
      it("exports: bundle Array<String> depBindings is turned to {dep1:[], dep2:[]}", function() {
        var a;
        return expect(a = blendConfigs([
          {
            dependencies: {
              exports: {
                bundle: ['lodash', 'jquery']
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': [],
                  'jquery': []
                }
              }
            }
          }
        });
      });
      it("exports: bundle {} - depBindings is `arrayize`d", function() {
        var a;
        return expect(a = blendConfigs([
          {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': '_'
                }
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': ['_']
                }
              }
            }
          }
        });
      });
      return it("exports: bundle {} - depBinding reseting its array", function() {
        return expect(blendConfigs([
          {}, {
            dependencies: {
              exports: {
                bundle: {
                  'uberscore': [[null], '_B']
                }
              }
            }
          }, {}, {
            dependencies: {
              exports: {
                bundle: {
                  'uberscore': ['uberscore', 'uuuuB']
                }
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'uberscore': ['_B']
                }
              }
            }
          }
        });
      });
    });
    return describe("Nested & derived configs:", function() {
      var blended, configs, configsClone;
      configs = [
        {}, {
          dependencies: {
            exports: {
              bundle: {
                lodash: "_"
              }
            }
          },
          filez: ['**/*.coffee.md', '**/*.ls'],
          dstPath: "build/code",
          template: 'UMD'
        }, {
          bundle: {
            path: "source/code",
            filez: ['**/*.litcoffee'],
            ignore: [/^draft/],
            dependencies: {
              exports: {
                bundle: {
                  uberscore: [[null], '_B']
                }
              }
            }
          },
          verbose: true,
          derive: {
            debugLevel: 90
          }
        }, {}, {
          bundlePath: "sourceSpecDir",
          main: 'index',
          filez: '**/*.*',
          resources: resources.slice(2),
          dependencies: {
            variableNames: {
              uberscore: '_B'
            },
            bundleExports: {
              chai: 'chai',
              uberscore: ['uberscore', 'B', 'B_'],
              'spec-data': 'data'
            }
          },
          dstPath: "some/useless/default/path"
        }, {}, {
          derive: [
            {
              dependencies: {
                exports: {
                  bundle: {
                    'spec-data': 'dataInDerive1'
                  }
                }
              }
            }, {
              derive: {
                derive: {
                  resources: resources.slice(0, 2),
                  derive: {
                    template: {
                      name: 'combined',
                      dummyOption: 'dummy'
                    }
                  }
                }
              },
              dependencies: {
                exports: {
                  bundle: {
                    'spec-data': 'dataInDerive2'
                  }
                }
              },
              verbose: false
            }
          ]
        }
      ];
      configsClone = _.clone(configs, true);
      blended = blendConfigs(configs);
      it("blending doesn't mutate source configs:", function() {
        return expect(configs).to.deep.equal(configsClone);
      });
      return it("correctly derives from many & nested user configs:", function() {
        return expect(blended).to.be.deep.equal({
          bundle: {
            path: "source/code",
            main: "index",
            filez: ['**/*.*', '**/*.litcoffee', '!', /^draft/, '**/*.coffee.md', '**/*.ls'],
            resources: expectedResources,
            dependencies: {
              exports: {
                bundle: {
                  'spec-data': ['dataInDerive2', 'dataInDerive1', 'data'],
                  chai: ['chai'],
                  uberscore: ['_B'],
                  lodash: ['_']
                }
              },
              depsVars: {
                uberscore: ['_B']
              }
            }
          },
          build: {
            verbose: true,
            dstPath: "build/code",
            debugLevel: 90,
            template: {
              name: "UMD"
            }
          }
        });
      });
    });
  });
});
