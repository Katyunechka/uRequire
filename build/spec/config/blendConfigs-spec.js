// Generated by CoffeeScript 1.6.3
var arrayizePushBlender, assert, blendConfigs, bundleBuildBlender, chai, dependenciesBindingsBlender, expect, expectedResources, l, moveKeysBlender, renameKeysBlender, resourceConverterBlender, resources, templateBlender, uRequireConfigMasterDefaults, _, _B;

chai = require('chai');

assert = chai.assert;

expect = chai.expect;

_B = require('uberscore');

l = new _B.Logger('urequire/blendConfigs-spec');

_ = require('lodash');

blendConfigs = require('../../code/config/blendConfigs');

uRequireConfigMasterDefaults = require('../../code/config/uRequireConfigMasterDefaults');

moveKeysBlender = blendConfigs.moveKeysBlender, renameKeysBlender = blendConfigs.renameKeysBlender, templateBlender = blendConfigs.templateBlender, dependenciesBindingsBlender = blendConfigs.dependenciesBindingsBlender, bundleBuildBlender = blendConfigs.bundleBuildBlender;

arrayizePushBlender = new _B.ArrayizePushBlender;

resourceConverterBlender = (require('../../code/config/ResourceConverters')).resourceConverterBlender;

resources = [
  [
    '$Coffeescript', ['**/*.coffee', /.*\.(coffee\.md|litcoffee)$/i, '!**/*.amd.coffee'], function(source) {
      return source;
    }, function(filename) {
      return filename.replace('.coffee', '.js');
    }
  ], [
    '!Streamline', 'I am the Streamline description', '**/*._*', function(source) {
      return source;
    }, function(filename) {
      return filename.replace('._js', '.js');
    }
  ], {
    name: '#|NonModule',
    filez: '**/*.nonmodule',
    convert: function() {}
  }, [
    '@~FileResource', '**/*.ext', function(source) {
      return source;
    }
  ], {
    name: '#IamAModule',
    type: 'module',
    filez: '**/*.module',
    convert: function() {}
  }
];

expectedResources = [
  {
    name: 'Coffeescript',
    description: void 0,
    filez: ['**/*.coffee', /.*\.(coffee\.md|litcoffee)$/i, '!**/*.amd.coffee'],
    isMatchSrcFilename: false,
    convert: resources[0][2],
    dstFilename: resources[0][3],
    type: 'module',
    isTerminal: false,
    isAfterTemplate: false
  }, {
    name: 'Streamline',
    description: 'I am the Streamline description',
    filez: '**/*._*',
    isMatchSrcFilename: false,
    convert: resources[1][3],
    dstFilename: resources[1][4],
    type: void 0,
    isTerminal: false,
    isAfterTemplate: true
  }, {
    name: 'NonModule',
    description: void 0,
    filez: '**/*.nonmodule',
    isMatchSrcFilename: false,
    convert: resources[2].convert,
    dstFilename: void 0,
    type: 'text',
    isTerminal: true,
    isAfterTemplate: false
  }, {
    name: 'FileResource',
    description: void 0,
    filez: '**/*.ext',
    isMatchSrcFilename: true,
    convert: resources[3][2],
    dstFilename: resources[3][3],
    type: 'file',
    isTerminal: false,
    isAfterTemplate: false
  }, {
    name: 'IamAModule',
    description: void 0,
    filez: '**/*.module',
    convert: resources[4].convert,
    dstFilename: void 0,
    type: 'module',
    isTerminal: false,
    isAfterTemplate: false,
    isMatchSrcFilename: false
  }
];

describe('`uRequireConfigMasterDefaults` consistency', function() {
  return it("No same name keys in bundle & build ", function() {
    return expect(_B.isDisjoint(_.keys(uRequireConfigMasterDefaults.bundle), _.keys(uRequireConfigMasterDefaults.build))).to.be["true"];
  });
});

describe('blendConfigs & its Blenders: ', function() {
  describe('moveKeysBlender:', function() {
    it("Copies keys from the 'root' of src, to either `dst.bundle` or `dst.build`, depending on where they are on `uRequireConfigMasterDefaults`", function() {
      var expected, rootLevelKeys;
      rootLevelKeys = {
        name: 'myBundle',
        main: 'myMainLib',
        bundle: {
          main: 'myLib'
        },
        path: "/some/path",
        webRootMap: ".",
        dependencies: {
          depsVars: {},
          exports: {
            bundle: {}
          }
        },
        dstPath: "",
        forceOverwriteSources: false,
        template: {
          name: "UMD"
        },
        watch: false,
        noRootExports: false,
        scanAllow: false,
        allNodeRequires: false,
        verbose: false,
        debugLevel: 0,
        done: function() {}
      };
      expected = moveKeysBlender.blend(rootLevelKeys);
      return expect(expected).to.deep.equal({
        bundle: {
          name: 'myBundle',
          main: 'myLib',
          path: "/some/path",
          webRootMap: ".",
          dependencies: {
            depsVars: {},
            exports: {
              bundle: {}
            }
          }
        },
        build: {
          dstPath: "",
          forceOverwriteSources: false,
          template: {
            name: "UMD"
          },
          watch: false,
          noRootExports: false,
          scanAllow: false,
          allNodeRequires: false,
          verbose: false,
          debugLevel: 0,
          done: rootLevelKeys.done
        }
      });
    });
    it("it gives precedence to items in 'bundle' and 'build' hashes, over root items.", function() {
      return expect(moveKeysBlender.blend({
        main: 'myMainLib',
        bundle: {
          main: 'myLib'
        },
        dstPath: "/some/OTHER/path",
        build: {
          dstPath: "/some/path"
        }
      })).to.deep.equal({
        bundle: {
          main: 'myLib'
        },
        build: {
          dstPath: "/some/path"
        }
      });
    });
    return it("ignores root keys deemed irrelevant (not exist on `uRequireConfigMasterDefaults`'s `.build` or `.bundle`.)", function() {
      return expect(moveKeysBlender.blend({
        iRReLeVaNt_key_is_Ignored: true,
        name: 'myBundle',
        bundle: {
          bundle_iRReLeVaNt_key_is_NOT_Ignored: true,
          path: "/some/path"
        }
      })).to.deep.equal({
        bundle: {
          bundle_iRReLeVaNt_key_is_NOT_Ignored: true,
          name: 'myBundle',
          path: "/some/path"
        }
      });
    });
  });
  describe("renameKeysBlender:", function() {
    return it("renames DEPRACATED keys to their new name", function() {
      var oldCfg;
      oldCfg = {
        bundle: {
          bundlePath: "source/code",
          main: "index",
          filespecs: '*.*',
          ignore: [/^draft/],
          dependencies: {
            noWeb: 'util',
            bundleExports: {
              lodash: '_'
            },
            _knownVariableNames: {
              jquery: '$'
            }
          }
        }
      };
      return expect(renameKeysBlender.blend(oldCfg)).to.be.deep.equal({
        bundle: {
          path: 'source/code',
          main: 'index',
          filez: '*.*',
          ignore: [/^draft/],
          dependencies: {
            node: 'util',
            exports: {
              bundle: {
                lodash: '_'
              }
            },
            _knownDepsVars: {
              jquery: '$'
            }
          }
        }
      });
    });
  });
  describe("templateBlender:", function() {
    describe("template is a String:", function() {
      it("converts to {name:'TheString'} ", function() {
        return expect(templateBlender.blend('UMD')).to.deep.equal({
          name: 'UMD'
        });
      });
      it("converts & blends to {name:'TheString'} ", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, 'UMD')).to.deep.equal({
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        });
      });
      return it("resets dest Object if src name is changed", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, 'combined')).to.deep.equal({
          name: 'combined'
        });
      });
    });
    return describe("template is {}:", function() {
      it("blends to existing ", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, {
          name: 'UMD'
        })).to.deep.equal({
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        });
      });
      return it("resets dest Object if template.name is changed", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, {
          name: 'combined'
        })).to.deep.equal({
          name: 'combined'
        });
      });
    });
  });
  describe("resourceConverterBlender:", function() {
    return it("converts array of array resources into array of object resources", function() {
      var resource, result, _i, _len;
      result = [];
      for (_i = 0, _len = resources.length; _i < _len; _i++) {
        resource = resources[_i];
        result.push(resourceConverterBlender.blend(resource));
      }
      return expect(result).to.deep.equal(expectedResources);
    });
  });
  describe("`dependenciesBindingsBlender` converts to proper dependenciesBinding structure\n{dependency1:ArrayOfDep1Bindings, dependency2:ArrayOfDep2Bindings, ...}\ni.e `{lodash:['_'], jquery: ['$']}` :", function() {
    it("converts String: `'lodash'`  --->   `{lodash:[]}`", function() {
      expect(dependenciesBindingsBlender.blend('lodash')).to.deep.equal({
        lodash: []
      });
      expect(dependenciesBindingsBlender.blend(void 0, 'lodash', 'jquery')).to.deep.equal({
        lodash: [],
        jquery: []
      });
      return expect(dependenciesBindingsBlender.blend({
        knockout: ['ko']
      }, 'lodash', 'jquery')).to.deep.equal({
        knockout: ['ko'],
        lodash: [],
        jquery: []
      });
    });
    it("converts Array<String>: `['lodash', 'jquery']` ---> `{lodash:[], jquery:[]}`", function() {
      expect(dependenciesBindingsBlender.blend(['lodash', 'jquery'])).to.deep.equal({
        lodash: [],
        jquery: []
      });
      return expect(dependenciesBindingsBlender.blend({
        lodash: '_',
        knockout: ['ko']
      }, ['lodash', 'jquery'])).to.deep.equal({
        lodash: ['_'],
        knockout: ['ko'],
        jquery: []
      });
    });
    it("converts Object {lodash:['_'], jquery: '$'}` = {lodash:['_'], jquery: ['$']}`", function() {
      return expect(dependenciesBindingsBlender.blend({
        lodash: ['_'],
        jquery: '$'
      })).to.deep.equal({
        lodash: ['_'],
        jquery: ['$']
      });
    });
    it("blends {lodash:['_'], jquery: ['$']} <-- {knockout:['ko'], jquery: ['jQuery']}`", function() {
      return expect(dependenciesBindingsBlender.blend({
        lodash: '_',
        jquery: ['$', 'jquery']
      }, {
        knockout: ['ko', 'Knockout'],
        jquery: 'jQuery'
      })).to.deep.equal({
        lodash: ['_'],
        knockout: ['ko', 'Knockout'],
        jquery: ['$', 'jquery', 'jQuery']
      });
    });
    return it("converts from all in chain ", function() {
      return expect(dependenciesBindingsBlender.blend({}, 'myLib', {
        lodash: ['_'],
        jquery: '$'
      }, ['uberscore', 'uderive'], {
        jquery: 'jQuery'
      }, 'urequire', {
        'uberscore': ['rules']
      })).to.deep.equal({
        myLib: [],
        lodash: ['_'],
        jquery: ['$', 'jQuery'],
        uberscore: ['rules'],
        uderive: [],
        urequire: []
      });
    });
  });
  return describe("`blendConfigs`:", function() {
    describe("`bundle: dependencies`:", function() {
      it("exports.bundle String depBindings is turned to {dep:[]}", function() {
        return expect(blendConfigs([
          {
            dependencies: {
              exports: {
                bundle: 'lodash'
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': []
                }
              }
            }
          }
        });
      });
      it("exports: bundle Array<String> depBindings is turned to {dep1:[], dep2:[]}", function() {
        var a;
        return expect(a = blendConfigs([
          {
            dependencies: {
              exports: {
                bundle: ['lodash', 'jquery']
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': [],
                  'jquery': []
                }
              }
            }
          }
        });
      });
      it("exports: bundle {} - depBindings is `arrayize`d", function() {
        var a;
        return expect(a = blendConfigs([
          {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': '_'
                }
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'lodash': ['_']
                }
              }
            }
          }
        });
      });
      return it("exports: bundle {} - depBinding reseting its array", function() {
        return expect(blendConfigs([
          {}, {
            dependencies: {
              exports: {
                bundle: {
                  'uberscore': [[null], '_B']
                }
              }
            }
          }, {}, {
            dependencies: {
              exports: {
                bundle: {
                  'uberscore': ['uberscore', 'uuuuB']
                }
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              exports: {
                bundle: {
                  'uberscore': ['_B']
                }
              }
            }
          }
        });
      });
    });
    return describe("Nested & derived configs:", function() {
      var blended, configs, configsClone;
      configs = [
        {}, {
          dependencies: {
            node: ['fs'],
            exports: {
              bundle: {
                lodash: "_",
                backbone: ['Backbone', 'BB']
              }
            }
          },
          filez: ['**/*.coffee.md', '**/*.ls'],
          copy: /./,
          dstPath: "build/code",
          template: 'UMD'
        }, {
          bundle: {
            path: "source/code",
            filez: ['**/*.litcoffee'],
            copy: ['**/*.html'],
            ignore: [/^draft/],
            dependencies: {
              node: 'util',
              exports: {
                bundle: {
                  uberscore: [[null], '_B']
                }
              }
            }
          },
          verbose: true,
          derive: {
            debugLevel: 90
          }
        }, {}, {
          bundlePath: "sourceSpecDir",
          main: 'index',
          filez: '**/*.*',
          resources: resources.slice(2),
          dependencies: {
            variableNames: {
              uberscore: '_B'
            },
            bundleExports: {
              chai: 'chai',
              uberscore: ['uberscore', 'B', 'B_'],
              'spec-data': 'data'
            }
          },
          dstPath: "some/useless/default/path"
        }, {
          dependencies: {
            bundleExports: ['backbone', 'unusedDep']
          }
        }, {
          dependencies: {
            bundleExports: 'dummyDep'
          }
        }, {}, {
          derive: [
            {
              dependencies: {
                exports: {
                  bundle: {
                    'spec-data': 'dataInDerive1'
                  }
                }
              }
            }, {
              derive: {
                derive: {
                  resources: resources.slice(0, 2),
                  derive: {
                    copy: ['!**/*.*'],
                    template: {
                      name: 'combined',
                      dummyOption: 'dummy'
                    }
                  }
                }
              },
              dependencies: {
                exports: {
                  bundle: {
                    'spec-data': 'dataInDerive2'
                  }
                }
              },
              verbose: false
            }
          ]
        }
      ];
      configsClone = _.clone(configs, true);
      blended = blendConfigs(configs);
      l.log(blended);
      it("blending doesn't mutate source configs:", function() {
        return expect(configs).to.deep.equal(configsClone);
      });
      return it("correctly derives from many & nested user configs:", function() {
        return expect(blended).to.be.deep.equal({
          bundle: {
            path: "source/code",
            main: "index",
            filez: ['**/*.*', '**/*.litcoffee', '!', /^draft/, '**/*.coffee.md', '**/*.ls'],
            copy: ['!**/*.*', '**/*.html', /./],
            resources: expectedResources,
            dependencies: {
              node: ['util', 'fs'],
              exports: {
                bundle: {
                  'spec-data': ['dataInDerive2', 'dataInDerive1', 'data'],
                  chai: ['chai'],
                  uberscore: ['_B'],
                  lodash: ['_'],
                  backbone: ['Backbone', 'BB'],
                  unusedDep: [],
                  dummyDep: []
                }
              },
              depsVars: {
                uberscore: ['_B']
              }
            }
          },
          build: {
            verbose: true,
            dstPath: "build/code",
            debugLevel: 90,
            template: {
              name: "UMD"
            }
          }
        });
      });
    });
  });
});
