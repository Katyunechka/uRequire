// Generated by CoffeeScript 1.6.2
var arrayizeUniquePusher, assert, blendConfigs, bundleBlender, chai, dependenciesBindingsBlender, expect, moveKeysBlender, templateBlender, uRequireConfigMasterDefaults, _;

chai = require('chai');

assert = chai.assert;

expect = chai.expect;

_ = require('lodash');

blendConfigs = require('../../code/config/blendConfigs');

uRequireConfigMasterDefaults = require('../../code/config/uRequireConfigMasterDefaults');

moveKeysBlender = blendConfigs.moveKeysBlender, templateBlender = blendConfigs.templateBlender, arrayizeUniquePusher = blendConfigs.arrayizeUniquePusher, dependenciesBindingsBlender = blendConfigs.dependenciesBindingsBlender, bundleBlender = blendConfigs.bundleBlender;

describe('blendConfigs & its Blenders', function() {
  describe('moveKeysBlender', function() {
    it("Copies keys from the 'root' of src, to either `dst.bundle` or `dst.build`, depending on where they are on `uRequireConfigMasterDefaults`", function() {
      return expect(moveKeysBlender.blend({
        bundleName: 'myBundle',
        main: 'myMainLib',
        bundle: {
          main: 'myLib'
        },
        bundlePath: "/some/path",
        webRootMap: ".",
        dependencies: {
          variableNames: {},
          bundleExports: {}
        },
        outputPath: "",
        forceOverwriteSources: false,
        template: {
          name: "UMD"
        },
        watch: false,
        noRootExports: false,
        scanAllow: false,
        allNodeRequires: false,
        verbose: false,
        debugLevel: 0
      })).to.deep.equal({
        bundle: {
          bundleName: 'myBundle',
          main: 'myLib',
          bundlePath: "/some/path",
          webRootMap: ".",
          dependencies: {
            variableNames: {},
            bundleExports: {}
          }
        },
        build: {
          outputPath: "",
          forceOverwriteSources: false,
          template: {
            name: "UMD"
          },
          watch: false,
          noRootExports: false,
          scanAllow: false,
          allNodeRequires: false,
          verbose: false,
          debugLevel: 0
        }
      });
    });
    it("it gives precedence to items in 'bundle' and 'build' hashes, over root items.", function() {
      return expect(moveKeysBlender.blend({
        main: 'myMainLib',
        bundle: {
          main: 'myLib'
        },
        outputPath: "/some/OTHER/path",
        build: {
          outputPath: "/some/path"
        }
      })).to.deep.equal({
        bundle: {
          main: 'myLib'
        },
        build: {
          outputPath: "/some/path"
        }
      });
    });
    return it("ignores root keys deemed irrelevant (not exist on `uRequireConfigMasterDefaults`'s `.build` or `.bundle`.)", function() {
      return expect(moveKeysBlender.blend({
        iRReLeVaNt_key_is_Ignored: true,
        bundleName: 'myBundle',
        bundle: {
          bundle_iRReLeVaNt_key_is_NOT_Ignored: true,
          bundlePath: "/some/path"
        }
      })).to.deep.equal({
        bundle: {
          bundle_iRReLeVaNt_key_is_NOT_Ignored: true,
          bundleName: 'myBundle',
          bundlePath: "/some/path"
        }
      });
    });
  });
  describe("templateBlender:", function() {
    describe("template is a String:", function() {
      it("converts to {name:'TheString'} ", function() {
        return expect(templateBlender.blend('UMD')).to.deep.equal({
          name: 'UMD'
        });
      });
      it("converts & blends to {name:'TheString'} ", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, 'UMD')).to.deep.equal({
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        });
      });
      return it("resets dest Object if src name is changed", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, 'combined')).to.deep.equal({
          name: 'combined'
        });
      });
    });
    return describe("template is {}:", function() {
      it("blends to existing ", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, {
          name: 'UMD'
        })).to.deep.equal({
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        });
      });
      return it("resets dest Object if template.name is changed", function() {
        return expect(templateBlender.blend({}, {
          name: 'UMD',
          otherRandomOption: 'someRandomValue'
        }, {}, {
          name: 'combined'
        })).to.deep.equal({
          name: 'combined'
        });
      });
    });
  });
  describe("arrayizeUniquePusher:", function() {
    it("pushes source array items into destination array", function() {
      return expect(arrayizeUniquePusher.blend([1, 2, 3], [4, 5, 6, '7'])).to.deep.equal([1, 2, 3, 4, 5, 6, '7']);
    });
    it("pushes only === unique items", function() {
      return expect(arrayizeUniquePusher.blend([1, 4, 2, 3], [1, 2, 4, 5, 6, '7'])).to.deep.equal([1, 4, 2, 3, 5, 6, '7']);
    });
    it("pushes source array items into non-array destination, arrayize'ing it first", function() {
      return expect(arrayizeUniquePusher.blend(123, [4, 5, 6])).to.deep.equal([123, 4, 5, 6]);
    });
    it("pushes source non-array (but a String) item into array destination", function() {
      return expect(arrayizeUniquePusher.blend(['1', '2', '3'], '456')).to.deep.equal(['1', '2', '3', '456']);
    });
    it("pushes non-array (but Strings) items onto each other", function() {
      return expect(arrayizeUniquePusher.blend('123', '456')).to.deep.equal(['123', '456']);
    });
    return it("resets destination array & then pushes - using signpost `[null]` as 1st src item", function() {
      return expect(arrayizeUniquePusher.blend(['items', 'to', 'remove'], [[null], 11, 22, 33])).to.deep.equal([11, 22, 33]);
    });
  });
  describe("`dependenciesBindingsBlender` converts to proper dependenciesBinding structure\n{dependency1:ArrayOfDep1Bindings, dependency2:ArrayOfDep2Bindings, ...}\ni.e `{lodash:['_'], jquery: ['$']}` :", function() {
    it("converts String: `'lodash'`  --->   `{lodash:[]}`", function() {
      return expect(dependenciesBindingsBlender.blend('lodash')).to.deep.equal({
        lodash: []
      });
    });
    it("converts Array<String>: `['lodash', 'jquery']` ---> `{lodash:[], jquery:[]}`", function() {
      return expect(dependenciesBindingsBlender.blend(['lodash', 'jquery'])).to.deep.equal({
        lodash: [],
        jquery: []
      });
    });
    it("converts Object {lodash:['_'], jquery: '$'}` ---> {lodash:['_'], jquery: ['$']}`", function() {
      return expect(dependenciesBindingsBlender.blend({
        lodash: ['_'],
        jquery: '$'
      })).to.deep.equal({
        lodash: ['_'],
        jquery: ['$']
      });
    });
    return it("converts from all in chain ", function() {
      return expect(dependenciesBindingsBlender.blend({}, 'myLib', {
        lodash: ['_'],
        jquery: '$'
      }, ['uberscore', 'uderive'], {
        jquery: 'jQuery'
      }, 'urequire', {
        'uberscore': ['rules']
      })).to.deep.equal({
        myLib: [],
        lodash: ['_'],
        jquery: ['$', 'jQuery'],
        uberscore: ['rules'],
        uderive: [],
        urequire: []
      });
    });
  });
  return describe("`blendConfigs`:", function() {
    describe("`bundle: dependencies`:", function() {
      it("noWeb is `arrayize`d", function() {
        return expect(blendConfigs([
          {
            dependencies: {
              noWeb: 'noWebForMe'
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              noWeb: ['noWebForMe']
            }
          }
        });
      });
      it("bundleExports String depBindings is turned to {dep:[]}", function() {
        return expect(blendConfigs([
          {
            dependencies: {
              bundleExports: 'lodash'
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              bundleExports: {
                'lodash': []
              }
            }
          }
        });
      });
      it("bundleExports Array<String> depBindings is turned to {dep1:[], dep2:[]}", function() {
        var a;

        return expect(a = blendConfigs([
          {
            dependencies: {
              bundleExports: ['lodash', 'jquery']
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              bundleExports: {
                'lodash': [],
                'jquery': []
              }
            }
          }
        });
      });
      it("bundleExports {} - depBindings is `arrayize`d", function() {
        var a;

        return expect(a = blendConfigs([
          {
            dependencies: {
              bundleExports: {
                'lodash': '_'
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              bundleExports: {
                'lodash': ['_']
              }
            }
          }
        });
      });
      return it("bundleExports {} - depBinding reseting its array", function() {
        return expect(blendConfigs([
          {}, {
            dependencies: {
              bundleExports: {
                'uberscore': [[null], '_B']
              }
            }
          }, {}, {
            dependencies: {
              bundleExports: {
                'uberscore': ['uberscore', 'uuuuB']
              }
            }
          }
        ])).to.deep.equal({
          bundle: {
            dependencies: {
              bundleExports: {
                'uberscore': ['_B']
              }
            }
          }
        });
      });
    });
    return describe("Nested & derived configs:", function() {
      var blended, configs, configsClone;

      configs = [
        {}, {
          dependencies: {
            bundleExports: {
              lodash: "_"
            }
          },
          outputPath: "build/code",
          template: 'UMD'
        }, {
          bundle: {
            bundlePath: "source/code",
            ignore: [/^draft/],
            dependencies: {
              bundleExports: {
                uberscore: [[null], '_B']
              },
              noWeb: "noWebForMe"
            }
          },
          verbose: true,
          derive: {
            debugLevel: 90
          }
        }, {}, {
          bundlePath: "sourceSpecDir",
          main: 'index',
          dependencies: {
            variableNames: {
              uberscore: '_B'
            },
            bundleExports: {
              chai: 'chai',
              uberscore: ['uberscore', 'B', 'B_'],
              'spec-data': 'data'
            }
          },
          outputPath: "some/useless/default/path"
        }, {}, {
          derive: [
            {
              dependencies: {
                noWeb: "noWebInDerive1",
                bundleExports: {
                  'spec-data': 'dataInDerive1'
                }
              }
            }, {
              derive: {
                derive: {
                  template: {
                    name: 'combined',
                    dummyOption: 'dummy'
                  }
                }
              },
              dependencies: {
                noWeb: "noWebInDerive2",
                bundleExports: {
                  'spec-data': 'dataInDerive2'
                }
              },
              verbose: false
            }
          ]
        }
      ];
      configsClone = _.clone(configs, true);
      blended = blendConfigs(configs);
      it("bledning doesn't mutate source configs:", function() {
        return expect(configs).to.deep.equal(configsClone);
      });
      return it("correctly derives from many & nested user configs:", function() {
        return expect(blended).to.deep.equal({
          bundle: {
            bundlePath: "source/code",
            main: "index",
            ignore: [/^draft/],
            dependencies: {
              noWeb: ['noWebInDerive2', 'noWebInDerive1', 'noWebForMe'],
              bundleExports: {
                'spec-data': ['dataInDerive2', 'dataInDerive1', 'data'],
                chai: ['chai'],
                uberscore: ['_B'],
                lodash: ['_']
              },
              variableNames: {
                uberscore: ['_B']
              }
            }
          },
          build: {
            verbose: true,
            outputPath: "build/code",
            debugLevel: 90,
            template: {
              name: "UMD"
            }
          }
        });
      });
    });
  });
});
