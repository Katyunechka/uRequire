// Generated by CoffeeScript 1.4.0
var Build, Bundle, BundleBuilder, Logger, YADC, l, uRequireConfigMasterDefaults, upath, _, _B, _Bs, _fs,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

_ = require('lodash');

_fs = require('fs');

_B = require('uberscore');

upath = require('../paths/upath');

Logger = require('../utils/Logger');

l = new Logger('BundleBuilder');

uRequireConfigMasterDefaults = require('../config/uRequireConfigMasterDefaults');

Bundle = require('./Bundle');

Build = require('./Build');

_Bs = require('../utils/uBerscoreShortcuts');

require('butter-require')();

/*
  Load config :
    * check options
    * Load (a) bundle(s) and (a) build(s)
    * Build & watch for changes
*/


BundleBuilder = (function() {
  var _this = this;

  Function.prototype.property = function(p) {
    var d, n, _results;
    _results = [];
    for (n in p) {
      d = p[n];
      _results.push(Object.defineProperty(this.prototype, n, d));
    }
    return _results;
  };

  Function.prototype.staticProperty = function(p) {
    var d, n, _results;
    _results = [];
    for (n in p) {
      d = p[n];
      _results.push(Object.defineProperty(BundleBuilder.prototype, n, d));
    }
    return _results;
  };

  function BundleBuilder() {
    this._constructor.apply(this, arguments);
  }

  BundleBuilder.prototype._constructor = function(config) {
    var be, cfgFilename, _base, _i, _len, _ref, _ref1, _ref2;
    this.bundleCfg = {};
    this.buildCfg = {};
    this.storeCfgDefaults(config);
    _ref = _B.arrayize(config.configFiles);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      cfgFilename = _ref[_i];
      if (!(cfgFilename)) {
        continue;
      }
      (_base = this.bundleCfg).bundlePath || (_base.bundlePath = upath.dirname(cfgFilename));
      this.storeCfgDefaults(require(_fs.realpathSync(cfgFilename)));
    }
    if (this.buildCfg.debugLevel != null) {
      Logger.prototype.debugLevel = this.buildCfg.debugLevel;
    }
    if (!this.buildCfg.verbose) {
      Logger.prototype.verbose = function() {};
    }
    if (be = (_ref1 = this.bundleCfg.dependencies) != null ? _ref1.bundleExports : void 0) {
      this.bundleCfg.dependencies.bundleExports = _Bs.toObjectKeysWithArrayValues(be);
      l.debug(20, "@bundleCfg.dependencies.bundleExports' = \n", JSON.stringify((_ref2 = this.bundleCfg.dependencies) != null ? _ref2.bundleExports : void 0, null, ' '));
    }
    if (this.isCheckAndFixPaths() && this.isCheckAndFixTemplate()) {
      l.debug(30, "@bundleCfg :\n", JSON.stringify(this.bundleCfg, null, ' '));
      l.debug(30, "@buildCfg :\n", JSON.stringify(this.buildCfg, null, ' '));
      this.storeCfgDefaults(uRequireConfigMasterDefaults);
      l.debug(99, "@buildCfg :\n", JSON.stringify(this.buildCfg, null, ' '));
      l.debug(99, "@buildCfg :\n", JSON.stringify(this.buildCfg, null, ' '));
      this.bundle = new Bundle(this.bundleCfg);
      this.build = new Build(this.buildCfg);
      return this.bundle.buildChangedModules(this.build);
    }
  };

  BundleBuilder.prototype.storeCfgDefaults = function(cfg) {
    this.bundleCfg = _B.deepCloneDefaults(this.bundleCfg, cfg.bundle || {});
    this.bundleCfg = _B.deepCloneDefaults(this.bundleCfg, _B.go(cfg, {
      fltr: _.keys(uRequireConfigMasterDefaults.bundle)
    }));
    this.buildCfg = _B.deepCloneDefaults(this.buildCfg, cfg.build || {});
    return this.buildCfg = _B.deepCloneDefaults(this.buildCfg, _B.go(cfg, {
      fltr: _.keys(uRequireConfigMasterDefaults.build)
    }));
  };

  BundleBuilder.prototype.isCheckAndFixTemplate = function() {
    var _ref;
    if (!this.buildCfg.template) {
      this.buildCfg.template = {
        name: 'UMD'
      };
    }
    if (_.isString(this.buildCfg.template)) {
      this.buildCfg.template = {
        name: this.buildCfg.template
      };
    }
    if (_ref = !(this.buildCfg.template.name != null), __indexOf.call(Build.templates, _ref) >= 0) {
      l.err("Quitting build, no valid template specified.\nUse -h for help");
      return false;
    }
    return true;
  };

  BundleBuilder.prototype.isCheckAndFixPaths = function() {
    if (!this.bundleCfg.bundlePath) {
      l.err("Quitting build, no bundlePath specified.\nUse -h for help");
      return false;
    } else {
      if (this.buildCfg.forceOverwriteSources) {
        this.buildCfg.outputPath = this.bundleCfg.bundlePath;
        l.verbose("Forced output to '" + this.buildCfg.outputPath + "'");
        return true;
      } else {
        if (!this.buildCfg.outputPath) {
          l.err("Quitting build, no --outputPath specified.\nUse -f *with caution* to overwrite sources.");
          return false;
        } else {
          if (this.buildCfg.outputPath === this.bundleCfg.bundlePath) {
            l.err("Quitting build, outputPath === bundlePath.\nUse -f *with caution* to overwrite sources (no need to specify --outputPath).");
            return false;
          }
        }
      }
    }
    return true;
  };

  return BundleBuilder;

}).call(this);

module.exports = BundleBuilder;

/* Debug information
*/


if (Logger.prototype.debugLevel > 10 || true) {
  YADC = require('YouAreDaChef').YouAreDaChef;
  YADC(BundleBuilder).before(/_constructor/, function(match, config) {
    return l.debug(1, "Before '" + match + "' with config = ", JSON.stringify(config, null, ' '));
  });
}
