// Generated by CoffeeScript 1.6.3
var addIgnoreToFilezAsExclude, arrayizeUniquePusher, blendConfigs, bundleBuildBlender, deepCloneBlender, dependenciesBindingsBlender, fs, functionCopyBB, l, moveKeysBlender, renameKeys, renameKeysBlender, resourcesBlender, templateBlender, uRequireConfigMasterDefaults, _, _B, _blendDerivedConfigs, _optimizers,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

_ = require('lodash');

fs = require('fs');

_B = require('uberscore');

require('butter-require')();

l = new _B.Logger('urequire/blendConfigs');

uRequireConfigMasterDefaults = require('./uRequireConfigMasterDefaults');

/* Define the various Blenders used*/


functionCopyBB = {
  order: ['src'],
  'Function': function(prop, src) {
    return src[prop];
  }
};

moveKeysBlender = new _B.DeepCloneBlender([
  functionCopyBB, {
    order: ['path'],
    '*': {
      '|': (function(partsKeys) {
        return function(prop, src, dst, bl) {
          var confPart, _i, _len, _ref;
          _ref = _.keys(partsKeys);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            confPart = _ref[_i];
            if (__indexOf.call(partsKeys[confPart], prop) >= 0) {
              _B.setp(bl.dstRoot, "/" + confPart + "/" + prop, src[prop], {
                overwrite: true
              });
              break;
            }
          }
          return _B.Blender.SKIP;
        };
      })({
        bundle: _.keys(uRequireConfigMasterDefaults.bundle),
        build: _.keys(uRequireConfigMasterDefaults.build)
      })
    },
    bundle: {
      '|': function() {
        return _B.Blender.NEXT;
      }
    },
    build: {
      '|': function() {
        return _B.Blender.NEXT;
      }
    }
  }
]);

renameKeys = {
  $: {
    bundle: {
      bundlePath: 'path',
      bundleName: 'name',
      copyNonResources: 'copy',
      filespecs: 'filez',
      dependencies: {
        bundleExports: 'exports.bundle',
        variableNames: 'depsVars',
        _knownVariableNames: '_knownDepsVars'
      }
    },
    build: {
      outputPath: 'dstPath'
    }
  }
};

_.extend(renameKeys.$, renameKeys.$.bundle);

_.extend(renameKeys.$, renameKeys.$.build);

renameKeysBlender = new _B.DeepDefaultsBlender([
  functionCopyBB, {
    order: ['src'],
    '*': function(prop, src, dst, bl) {
      var renameTo;
      renameTo = _B.getp(renameKeys, bl.path);
      if (_.isString(renameTo)) {
        l.warn("DEPRACATED key '" + (_.last(bl.path)) + "' found @ config path '" + (bl.path.join('.')) + "' - rename to '" + renameTo + "'");
        _B.setp(bl.dstRoot, bl.path.slice(1, -1).join('.') + '.' + renameTo, src[prop], {
          overwrite: true,
          separator: '.'
        });
        return _B.Blender.SKIP;
      }
      return _B.Blender.NEXT;
    }
  }
]);

addIgnoreToFilezAsExclude = function(cfg) {
  var filez, ignore, ignoreSpec, _i, _len, _ref, _ref1;
  ignore = _B.arrayize(((_ref = cfg.bundle) != null ? _ref.ignore : void 0) || cfg.ignore);
  if (!_.isEmpty(ignore)) {
    l.warn("DEPRACATED key 'ignore' found @ config - adding them as exclude '!' to 'bundle.filez'");
    filez = _B.arrayize(((_ref1 = cfg.bundle) != null ? _ref1.filez : void 0) || cfg.filez || ['**/*.*']);
    for (_i = 0, _len = ignore.length; _i < _len; _i++) {
      ignoreSpec = ignore[_i];
      filez.push('!');
      filez.push(ignoreSpec);
    }
    delete cfg.ignore;
    delete cfg.bundle.ignore;
    _B.setp(cfg, ['bundle', 'filez'], filez, {
      overwrite: true
    });
  }
  return cfg;
};

_optimizers = uRequireConfigMasterDefaults.build._optimizers;

bundleBuildBlender = new _B.DeepCloneBlender([
  functionCopyBB, {
    order: ['path', 'src'],
    bundle: {
      filez: {
        '|': {
          '*': 'pushUnique'
        }
      },
      resources: {
        '|': {
          '*': 'pushUnique'
        }
      },
      dependencies: {
        exports: {
          bundle: {
            '|': {
              '*': 'dependenciesBindings'
            }
          }
        },
        depsVars: {
          '|': {
            '*': 'dependenciesBindings'
          }
        },
        _knownDepsVars: {
          '|': {
            '*': 'dependenciesBindings'
          }
        }
      }
    },
    pushUnique: function(prop, src, dst) {
      return arrayizeUniquePusher.blend(dst[prop], resourcesBlender.blend([], src[prop]));
    },
    dependenciesBindings: function(prop, src, dst) {
      return dependenciesBindingsBlender.blend(dst[prop], src[prop]);
    },
    build: {
      template: {
        '|': {
          '*': function(prop, src, dst) {
            return templateBlender.blend(dst[prop], src[prop]);
          }
        }
      },
      optimize: {
        '|': {
          Boolean: function(prop, src, dst) {
            if (src[prop]) {
              return _optimizers[0];
            }
          },
          String: function(prop, src, dst) {
            var optimizer;
            if (!(optimizer = _.find(_optimizers, function(v) {
              return v === src[prop];
            }))) {
              l.err("Unknown optimize '" + src[prop] + "' - using 'uglify2' as default");
              return _optimizers[0];
            } else {
              return optimizer;
            }
          },
          Object: function(prop, src, dst) {
            var optimizer;
            if (!(optimizer = _.find(_optimizers, function(v) {
              return __indexOf.call(_.keys(src[prop]), v) >= 0;
            }))) {
              l.err("Unknown optimize object", src[prop], " - using 'uglify2' as default");
              return _optimizers[0];
            } else {
              dst[optimizer] = src[prop][optimizer];
              return optimizer;
            }
          }
        }
      }
    }
  }
]);

/*
*dependenciesBindingsBlender*

Converts String, Array<String> or Object {variable:bindingsArrayOfStringsOrString
to the 'proper' dependenciesBinding structure ({dependency1:ArrayOfDep1Bindings, dependency2:ArrayOfDep2Bindings, ...}

So with    *source*                 is converted to proper      *destination*
* String : `'lodash'`                       --->                `{lodash:[]}`

* Array<String>: `['lodash', 'jquery']`     --->            `{lodash:[], jquery:[]}`

* Object: `{lodash:['_'], jquery: '$'}`     --->          as is @todo: convert '$' to proper ['$'], i.e `{lodash:['_'], jquery: ['$']}`

The resulting array of bindings for each 'variable' is blended via arrayizeUniquePusher
to the existing? corresponding array on the destination
*/


dependenciesBindingsBlender = new _B.DeepCloneBlender([
  {
    order: ['src'],
    'String': function(prop, src, dst) {
      return arrayizeUniquePusher.blend(dst[prop], _B.okv({}, src[prop], []));
    },
    'Array': function(prop, src, dst) {
      var varBindings;
      varBindings = {};
      _B.go(src[prop], {
        grab: function(v) {
          return varBindings[v] || (varBindings[v] = []);
        }
      });
      return arrayizeUniquePusher.blend(dst[prop], varBindings);
    },
    'Object': function(prop, src, dst) {
      return arrayizeUniquePusher.blend(dst[prop], src[prop]);
    }
  }
]);

deepCloneBlender = new _B.DeepCloneBlender;

templateBlender = new _B.DeepCloneBlender([
  {
    order: ['src'],
    'String': function(prop, src, dst) {
      var _ref;
      if (src[prop] !== ((_ref = dst[prop]) != null ? _ref.name : void 0)) {
        dst[prop] = {};
      }
      return deepCloneBlender.blend(dst[prop], {
        name: src[prop]
      });
    },
    'Object': 'templateSetter',
    templateSetter: function(prop, src, dst) {
      var _ref;
      if (src[prop].name !== ((_ref = dst[prop]) != null ? _ref.name : void 0) && !_.isUndefined(src[prop].name)) {
        dst[prop] = {};
      }
      return deepCloneBlender.blend(dst[prop], src[prop]);
    }
  }
]);

arrayizeUniquePusher = new _B.DeepCloneBlender([
  {
    order: ['src'],
    unique: true,
    'Array': 'pushToArray',
    'String': 'pushToArray',
    'Number': 'pushToArray',
    'Undefined': 'pushToArray',
    pushToArray: function(prop, src, dst, bl) {
      var itemsToPush, srcArray, v, _i, _len;
      dst[prop] = _B.arrayize(dst[prop]);
      srcArray = _B.arrayize(src[prop]);
      if (_.isEqual(srcArray[0], [null])) {
        dst[prop] = [];
        srcArray = srcArray.slice(1);
      }
      itemsToPush = bl.currentBlenderBehavior.unique ? (function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = srcArray.length; _i < _len; _i++) {
          v = srcArray[_i];
          if (__indexOf.call(dst[prop], v) < 0) {
            _results.push(v);
          }
        }
        return _results;
      })() : srcArray;
      for (_i = 0, _len = itemsToPush.length; _i < _len; _i++) {
        v = itemsToPush[_i];
        dst[prop].push(v);
      }
      return dst[prop];
    }
  }
]);

resourcesBlender = new _B.DeepCloneBlender([
  {
    order: ['path', 'src'],
    '*': {
      '|': {
        '[]': function(prop, src) {
          var convert, dstFilename, filez, isModule, isTerminal, name, resource, _ref;
          resource = src[prop];
          name = resource[0];
          while ((_ref = name[0]) === '#' || _ref === '*') {
            switch (name[0]) {
              case '#':
                isModule = false;
                break;
              case '*':
                isTerminal = false;
            }
            name = name.slice(1);
          }
          if (isModule == null) {
            isModule = true;
          }
          if (isTerminal == null) {
            isTerminal = true;
          }
          filez = resource[1];
          convert = resource[2];
          dstFilename = resource[3];
          return {
            name: name,
            isModule: isModule,
            isTerminal: isTerminal,
            filez: filez,
            convert: convert,
            dstFilename: dstFilename
          };
        },
        '{}': function(prop, src) {
          var resource, _ref;
          resource = _.clone(src[prop], true);
          while ((_ref = resource.name[0]) === '#' || _ref === '*') {
            switch (resource.name[0]) {
              case '#':
                if (resource.isModule == null) {
                  resource.isModule = false;
                }
                break;
              case '*':
                if (resource.isTerminal == null) {
                  resource.isTerminal = false;
                }
            }
            resource.name = resource.name.slice(1);
          }
          if (resource.isModule == null) {
            resource.isModule = true;
          }
          if (resource.isTerminal == null) {
            resource.isTerminal = true;
          }
          return resource;
        }
      }
    }
  }
]);

blendConfigs = function(configsArray, deriveLoader) {
  var finalCfg;
  finalCfg = {};
  deriveLoader = _.isFunction(deriveLoader) ? deriveLoader : function(derive) {
    var cfgObject;
    if (_.isString(derive)) {
      l.debug("Loading config file: '" + derive + "'");
      if (cfgObject = require(fs.realpathSync(derive))) {
        return cfgObject;
      }
    } else {
      if (_.isObject(derive)) {
        return derive;
      }
    }
    return l.err("Error loading configuration files:\n  derive ", derive, " is a not a valid filename\nwhile processing derive array ['" + (derive.join("', '")) + "']\"");
  };
  _blendDerivedConfigs(finalCfg, configsArray, deriveLoader);
  return finalCfg;
};

_blendDerivedConfigs = function(cfgDest, cfgsArray, deriveLoader) {
  var cfg, derivedObjects, drv, _i;
  for (_i = cfgsArray.length - 1; _i >= 0; _i += -1) {
    cfg = cfgsArray[_i];
    if (!(cfg)) {
      continue;
    }
    derivedObjects = (function() {
      var _j, _len, _ref, _results;
      _ref = _B.arrayize(cfg.derive);
      _results = [];
      for (_j = 0, _len = _ref.length; _j < _len; _j++) {
        drv = _ref[_j];
        if (drv) {
          _results.push(deriveLoader(drv));
        }
      }
      return _results;
    })();
    if (!_.isEmpty(derivedObjects)) {
      _blendDerivedConfigs(cfgDest, derivedObjects, deriveLoader);
    }
    bundleBuildBlender.blend(cfgDest, moveKeysBlender.blend(addIgnoreToFilezAsExclude(renameKeysBlender.blend(cfg))));
  }
  return null;
};

module.exports = blendConfigs;

_.extend(blendConfigs, {
  moveKeysBlender: moveKeysBlender,
  renameKeysBlender: renameKeysBlender,
  templateBlender: templateBlender,
  resourcesBlender: resourcesBlender,
  arrayizeUniquePusher: arrayizeUniquePusher,
  dependenciesBindingsBlender: dependenciesBindingsBlender,
  bundleBuildBlender: bundleBuildBlender
});
